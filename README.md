# 📋 Sistema de Presença IPDA

<div align="center">
  <img src="public/images/logodeuseamor.png" alt="Igreja Pentecostal Deus é Amor" width="120" height="120">
  
  **Sistema Moderno de Controle de Presença para Igreja Pentecostal Deus é Amor**
  
  [![Next.js](https://img.shields.io/badge/Next.js-15.3.3-black?style=flat-square&logo=next.js)](https://nextjs.org/)
  [![TypeScript](https://img.shields.io/badge/TypeScript-5.0-blue?style=flat-square&logo=typescript)](https://www.typescriptlang.org/)
  [![Firebase](https://img.shields.io/badge/Firebase-11.9.1-orange?style=flat-square&logo=firebase)](https://firebase.google.com/)
  [![Tailwind CSS](https://img.shields.io/badge/Tailwind-3.4.1-38B2AC?style=flat-square&logo=tailwind-css)](https://tailwindcss.com/)
  [![React](https://img.shields.io/badge/React-18.3.1-61DAFB?style=flat-square&logo=react)](https://reactjs.org/)
  
  **👨‍💻 Desenvolvido por AchillesOS**
</div>

---

## 🎯 **Visão Geral**

O Sistema de Presença IPDA é uma aplicação web moderna e responsiva desenvolvida especificamente para o controle e gerenciamento de presença dos membros da Igreja Pentecostal Deus é Amor. O sistema oferece recursos avançados de analytics, controle de usuários e configurações dinâmicas, tudo em tempo real.

### ✨ **Principais Características**

- 📊 **Dashboard Interativo** com analytics em tempo real e métricas detalhadas
- 👥 **Gerenciamento Completo de Usuários** com controle de permissões multi-nível
- 🔧 **Configurações Dinâmicas** de cargos, turnos e opções do sistema
- 📱 **100% Responsivo** - interface otimizada para mobile, tablet e desktop
- 🔒 **Sistema de Segurança Robusto** com diferentes níveis de acesso (Super/Admin/Normal)
- 📈 **Relatórios Avançados** com gráficos interativos e estatísticas detalhadas
- ⚡ **Performance Otimizada** com Next.js 15+ e carregamento ultrarrápido
- 🔄 **Atualizações em Tempo Real** via Firebase Realtime Database
- 🎨 **Interface Moderna** com Shadcn/ui e animações suaves
- 💾 **Backup Automático** de dados e configurações

---

## 🚀 **Tecnologias Utilizadas**

### **Frontend**

- **Next.js 15.3.3** - Framework React com App Router, SSR e SSG
- **TypeScript 5.0** - Tipagem estática para maior segurança e produtividade
- **React 18.3.1** - Biblioteca JavaScript para interfaces de usuário
- **Tailwind CSS 3.4.1** - Framework CSS utility-first para estilização rápida
- **Shadcn/ui** - Sistema de componentes moderno e acessível
- **Lucide React** - Ícones SVG otimizados e consistentes
- **Radix UI** - Componentes headless com acessibilidade nativa

### **Backend & Database**

- **Firebase 11.9.1** - Plataforma completa para desenvolvimento
- **Firestore** - Banco de dados NoSQL em tempo real
- **Firebase Authentication** - Sistema de autenticação seguro e escalável
- **Firebase Hosting** - Deploy e hospedagem com CDN global
- **Firebase Security Rules** - Controle de acesso granular e robusto

### **Ferramentas de Desenvolvimento**

- **React Hook Form 7.54.2** - Gerenciamento eficiente de formulários
- **Zod 3.24.2** - Validação de schemas com TypeScript
- **Date-fns 3.6.0** - Manipulação moderna de datas
- **Recharts 2.15.1** - Gráficos e visualizações interativas
- **Class Variance Authority** - Gerenciamento de variantes CSS
- **Clsx** - Utilitário para concatenação condicional de classes

### **AI & Analytics**

- **Google AI Genkit 1.13.0** - Integração com IA para insights avançados
- **Analytics Personalizados** - Métricas customizadas para a igreja

---

## 📋 **Funcionalidades Detalhadas**

### 🏠 **Dashboard Principal**

- **📊 Visão Geral em Tempo Real**: Presenças do dia com atualização automática
- **📈 Gráficos Interativos**: Estatísticas por período, cargo e região
- **🔍 Resumo de Atividades**: Histórico recente de registros e alterações
- **⚡ Indicadores de Performance**: Métricas de participação e engajamento
- **📱 Widget de Notificações**: Alertas e lembretes importantes

### 👤 **Sistema de Usuários Multi-Nível**

- **🔑 Super Usuários**: Acesso administrativo completo ao sistema
  - Gerenciamento total de usuários e permissões
  - Configuração global do sistema
  - Acesso a dados sensíveis e relatórios administrativos
- **⚙️ Usuários Administradores**: Acesso limitado às funções administrativas
  - Gerenciamento de usuários comuns
  - Configuração de opções básicas
- **👥 Usuários Normais**: Acesso às funcionalidades essenciais
  - Registro de presença
  - Visualização de relatórios pessoais
- **🛡️ Proteção de Rotas**: Sistema avançado de guards e validações

### 📝 **Registro de Presença Inteligente**

- **📱 Formulário Responsivo**: Interface otimizada para qualquer dispositivo
- **🔧 Campos Dinâmicos**: Configuração flexível de campos e opções
- **✅ Validação em Tempo Real**: Feedback instantâneo durante o preenchimento
- **📊 Múltiplos Status**: Presente, Ausente, Justificado com detalhamento
- **💾 Auto-save**: Salvamento automático para evitar perda de dados
- **🔍 Busca Inteligente**: Localização rápida de membros por nome ou CPF

### 📊 **Relatórios e Analytics Avançados**

- **📈 Dashboard de Estatísticas**: Métricas em tempo real com gráficos interativos
- **📅 Análise Temporal**: Relatórios por dia, semana, mês e período customizado
- **👥 Segmentação Avançada**: Análise por cargo, região e classificação
- **📉 Tendências e Padrões**: Identificação de comportamentos e sazonalidades
- **📋 Relatórios Personalizados**: Geração de relatórios sob medida
- **💾 Exportação Flexível**: Download em múltiplos formatos (PDF, Excel, CSV)
- **🔔 Alertas Automáticos**: Notificações baseadas em métricas pré-definidas

### ⚙️ **Configurações Dinâmicas e Personalização**

- **🏛️ Gerenciamento de Cargos**: Adição/remoção dinâmica de posições da igreja
- **🌍 Controle de Regiões**: Configuração flexível de áreas geográficas
- **⏰ Gestão de Turnos**: Personalização de horários e períodos
- **🎛️ Opções do Sistema**: Configuração de comportamentos e preferências
- **💾 Backup e Restore**: Sistema de backup automático e manual
- **🔄 Sincronização**: Atualização em tempo real em todos os dispositivos
- **🎨 Personalização Visual**: Temas e cores customizáveis

### 🔒 **Segurança e Auditoria**

- **🛡️ Autenticação Robusta**: Sistema Firebase com múltiplos fatores
- **📝 Log de Auditoria**: Rastreamento completo de ações do sistema
- **🔐 Controle de Sessão**: Gerenciamento seguro de sessões ativas
- **⚠️ Monitoramento**: Detecção de atividades suspeitas
- **🔒 Criptografia**: Proteção de dados sensíveis
- **🚫 Rate Limiting**: Proteção contra ataques e uso abusivo

---

## 🔧 **Instalação e Configuração**

### **Pré-requisitos**

- **Node.js 18+** - Runtime JavaScript
- **npm** ou **yarn** - Gerenciador de pacotes
- **Conta Firebase** - Backend e autenticação
- **Git** - Controle de versão

### **1. Clone o Repositório**

```bash
git clone https://github.com/AchillesOS/sistema-presenca-ipda.git
cd sistema-presenca-ipda
```

### **2. Instale as Dependências**

```bash
# Usando npm
npm install

# Usando yarn
yarn install
```

### **3. Configuração do Firebase**

#### **3.1. Criar Projeto Firebase**

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Clique em "Criar projeto"
3. Configure o projeto com nome: `sistema-presenca-ipda`
4. Ative Google Analytics (opcional)

#### **3.2. Configurar Serviços**

1. **Authentication**:
   - Ative o provedor "Email/senha"
   - Configure domínios autorizados
2. **Firestore Database**:
   - Crie banco no modo "produção"
   - Configure regras de segurança
3. **Hosting** (opcional):
   - Configure para deploy automático

#### **3.3. Obter Credenciais**

1. Vá em "Configurações do projeto"
2. Na aba "Geral", encontre "Seus aplicativos"
3. Clique em "Web" e registre o app
4. Copie as configurações do Firebase

#### **3.4. Configurar Variáveis de Ambiente**

Crie o arquivo `.env.local` na raiz do projeto:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sistema-presenca-ipda.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sistema-presenca-ipda
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sistema-presenca-ipda.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional: Analytics
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Development
NODE_ENV=development
```

### **4. Configurar Firestore Rules**

#### **4.1. Instalar Firebase CLI**

```bash
npm install -g firebase-tools
firebase login
firebase init firestore
```

#### **4.2. Deploy das Regras**

```bash
firebase deploy --only firestore:rules
```

### **5. Configuração Inicial do Sistema**

#### **5.1. Criar Super Usuário**

1. Execute o projeto em desenvolvimento
2. Registre o primeiro usuário
3. No Firebase Console, adicione o campo `role: 'super'` ao documento do usuário

#### **5.2. Configurar Dados Iniciais**

```bash
# Executar script de configuração inicial (se disponível)
npm run setup:initial-data
```

### **6. Executar o Projeto**

#### **Desenvolvimento**

```bash
npm run dev
# ou
yarn dev
```

Acesse: `http://localhost:9002`

#### **Produção Local**

```bash
npm run build
npm run start
```

#### **Com Turbopack (Mais Rápido)**

```bash
npm run dev:turbo
```

### **7. Configurações Avançadas**

#### **7.1. Analytics e IA (Opcional)**

```bash
# Configurar Genkit para IA
npm run genkit:dev

# Iniciar em modo watch
npm run genkit:watch
```

#### **7.2. Configurar Domínio Personalizado**

1. No Firebase Hosting, adicione domínio customizado
2. Configure DNS para apontar para Firebase
3. SSL será configurado automaticamente

### **8. Verificação da Instalação**

#### **Checklist de Verificação**

- [ ] ✅ Página inicial carrega corretamente
- [ ] 🔐 Sistema de login funciona
- [ ] 📊 Dashboard exibe dados
- [ ] 📝 Formulário de presença funciona
- [ ] 👥 Gerenciamento de usuários acessível (super usuários)
- [ ] ⚙️ Configurações dinâmicas respondem
- [ ] 📱 Interface responsiva em mobile

#### **Solução de Problemas Comuns**

```bash
# Limpar cache do Next.js
rm -rf .next

# Reinstalar dependências
rm -rf node_modules package-lock.json
npm install

# Verificar variáveis de ambiente
npm run env:check

# Verificar conexão Firebase
npm run firebase:test
```

---

## 🏗️ **Estrutura do Projeto**

```
src/
├── app/                    # App Router (Next.js 13+)
│   ├── (auth)/            # Páginas de autenticação
│   ├── admin/             # Páginas administrativas
│   ├── config/            # Configurações do sistema
│   └── reports/           # Relatórios e analytics
├── components/            # Componentes React
│   ├── ui/               # Componentes base (Shadcn)
│   ├── auth/             # Componentes de autenticação
│   ├── layout/           # Layout e navegação
│   └── admin/            # Componentes administrativos
├── hooks/                # Custom hooks
├── lib/                  # Utilitários e configurações
│   ├── firebase.ts       # Configuração Firebase
│   ├── auth.ts           # Lógica de autenticação
│   ├── actions.ts        # Actions do Firestore
│   └── types.ts          # Definições de tipos
└── styles/               # Estilos globais
```

---

## 🔐 **Sistema de Autenticação e Segurança**

### **Hierarquia de Usuários**

#### **🔥 Super Usuários (Nível 3)**

**E-mails Autorizados:**

- `admin@ipda.org.br`
- `marciodesk@ipda.app.br`

**Permissões Completas:**

- ✅ **Gerenciamento Total**: Criar, editar e excluir qualquer usuário
- ✅ **Configuração Global**: Modificar todas as configurações do sistema
- ✅ **Dados Sensíveis**: Acesso a informações confidenciais e métricas avançadas
- ✅ **Audit Trail**: Visualizar logs completos de auditoria
- ✅ **Backup/Restore**: Gerenciar backups e restaurações
- ✅ **Sistema**: Configurar regras de negócio e validações
- ✅ **Deploy**: Controlar atualizações e manutenções

#### **⚙️ Administradores (Nível 2)**

**Permissões Administrativas:**

- ✅ **Usuários Comuns**: Gerenciar usuários não-administrativos
- ✅ **Relatórios**: Gerar e visualizar relatórios administrativos
- ✅ **Configurações Básicas**: Modificar cargos e opções básicas
- ✅ **Moderação**: Revisar e aprovar registros pendentes
- ❌ **Super Funções**: Não pode gerenciar outros admins ou super usuários

#### **👤 Usuários Normais (Nível 1)**

**Permissões Básicas:**

- ✅ **Dashboard Pessoal**: Visualizar métricas próprias
- ✅ **Registro**: Cadastrar presenças e informações pessoais
- ✅ **Relatórios Pessoais**: Ver próprios dados e estatísticas
- ✅ **Perfil**: Editar informações pessoais básicas
- ❌ **Funções Administrativas**: Sem acesso a painéis administrativos

### **🛡️ Implementações de Segurança**

```typescript
// Verificação de autenticação
const isAuthenticated = user && user.uid;

// Verificação de nível de acesso
const isSuperUser = user?.email && SUPER_USERS.includes(user.email);
const isAdmin = user?.role === "admin" || isSuperUser;

// Guards de proteção
<SuperUserGuard>
  <AdminPanel />
</SuperUserGuard>;
```

#### **Regras de Firestore (Produção)**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar super usuários
    function isSuperUser() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@ipda.org.br',
               'marciodesk@ipda.app.br'
             ];
    }

    // Função para verificar admin
    function isAdmin() {
      return isSuperUser() ||
             (request.auth != null &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Attendance: Leitura para todos autenticados, escrita apenas para admins+
    match /attendance/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users: Apenas super usuários podem gerenciar
    match /users/{document} {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
      allow create: if request.auth != null && request.auth.uid == document;
    }

    // System config: Apenas admins+ podem modificar
    match /system/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
```

#### **Validações Client-Side**

```typescript
// Validação de dados com Zod
const attendanceSchema = z.object({
  fullName: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  cpf: z.string().regex(/^\d{11}$/, "CPF deve ter 11 dígitos"),
  status: z.enum(["Presente", "Ausente", "Justificado"]),
  timestamp: z.date(),
});

// Sanitização de inputs
const sanitizeInput = (input: string) => {
  return DOMPurify.sanitize(input.trim());
};
```

#### **Proteções Adicionais**

- 🔒 **Rate Limiting**: Controle de requisições por usuário
- 🛡️ **CORS**: Configurado para domínios específicos
- 🔐 **Headers de Segurança**: X-Frame-Options, CSP, HSTS
- 🚫 **XSS Protection**: Sanitização de inputs e outputs
- 📝 **Audit Logging**: Log completo de ações críticas
- ⚠️ **Anomaly Detection**: Detecção de padrões suspeitos

### **🔍 Monitoramento e Auditoria**

#### **Logs de Auditoria**

```typescript
// Log automático de ações críticas
const auditLog = {
  userId: user.uid,
  userEmail: user.email,
  action: "USER_CREATED",
  targetId: newUser.uid,
  timestamp: new Date(),
  details: { role: "admin", region: "São Paulo" },
  ipAddress: request.ip,
  userAgent: request.headers["user-agent"],
};
```

#### **Alertas de Segurança**

- 🚨 **Login Suspeito**: Tentativas de locais não usuais
- ⚠️ **Múltiplas Tentativas**: Bloqueio temporário após falhas
- 📧 **Notificações**: Email para admins em ações críticas
- 📊 **Dashboard de Segurança**: Métricas de segurança em tempo real

### **🔒 Melhores Práticas Implementadas**

1. **Princípio do Menor Privilégio**: Usuários recebem apenas permissões necessárias
2. **Separação de Responsabilidades**: Diferentes níveis para diferentes funções
3. **Validação Dupla**: Client-side + server-side validation
4. **Criptografia**: Dados sensíveis sempre criptografados
5. **Sessões Seguras**: Timeout automático e renovação de tokens
6. **Backup de Segurança**: Backups criptografados e versionados

---

## 🔧 **Instalação e Configuração**

### **Pré-requisitos**

- **Node.js 18+** - Runtime JavaScript
- **npm** ou **yarn** - Gerenciador de pacotes
- **Conta Firebase** - Backend e autenticação
- **Git** - Controle de versão

### **1. Clone o Repositório**

```bash
git clone https://github.com/AchillesOS/sistema-presenca-ipda.git
cd sistema-presenca-ipda
```

### **2. Instale as Dependências**

```bash
# Usando npm
npm install

# Usando yarn
yarn install
```

### **3. Configuração do Firebase**

#### **3.1. Criar Projeto Firebase**

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Clique em "Criar projeto"
3. Configure o projeto com nome: `sistema-presenca-ipda`
4. Ative Google Analytics (opcional)

#### **3.2. Configurar Serviços**

1. **Authentication**:
   - Ative o provedor "Email/senha"
   - Configure domínios autorizados
2. **Firestore Database**:
   - Crie banco no modo "produção"
   - Configure regras de segurança
3. **Hosting** (opcional):
   - Configure para deploy automático

#### **3.3. Obter Credenciais**

1. Vá em "Configurações do projeto"
2. Na aba "Geral", encontre "Seus aplicativos"
3. Clique em "Web" e registre o app
4. Copie as configurações do Firebase

#### **3.4. Configurar Variáveis de Ambiente**

Crie o arquivo `.env.local` na raiz do projeto:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sistema-presenca-ipda.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sistema-presenca-ipda
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sistema-presenca-ipda.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional: Analytics
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Development
NODE_ENV=development
```

### **4. Configurar Firestore Rules**

#### **4.1. Instalar Firebase CLI**

```bash
npm install -g firebase-tools
firebase login
firebase init firestore
```

#### **4.2. Deploy das Regras**

```bash
firebase deploy --only firestore:rules
```

### **5. Configuração Inicial do Sistema**

#### **5.1. Criar Super Usuário**

1. Execute o projeto em desenvolvimento
2. Registre o primeiro usuário
3. No Firebase Console, adicione o campo `role: 'super'` ao documento do usuário

#### **5.2. Configurar Dados Iniciais**

```bash
# Executar script de configuração inicial (se disponível)
npm run setup:initial-data
```

### **6. Executar o Projeto**

#### **Desenvolvimento**

```bash
npm run dev
# ou
yarn dev
```

Acesse: `http://localhost:9002`

#### **Produção Local**

```bash
npm run build
npm run start
```

#### **Com Turbopack (Mais Rápido)**

```bash
npm run dev:turbo
```

### **7. Configurações Avançadas**

#### **7.1. Analytics e IA (Opcional)**

```bash
# Configurar Genkit para IA
npm run genkit:dev

# Iniciar em modo watch
npm run genkit:watch
```

#### **7.2. Configurar Domínio Personalizado**

1. No Firebase Hosting, adicione domínio customizado
2. Configure DNS para apontar para Firebase
3. SSL será configurado automaticamente

### **8. Verificação da Instalação**

#### **Checklist de Verificação**

- [ ] ✅ Página inicial carrega corretamente
- [ ] 🔐 Sistema de login funciona
- [ ] 📊 Dashboard exibe dados
- [ ] 📝 Formulário de presença funciona
- [ ] 👥 Gerenciamento de usuários acessível (super usuários)
- [ ] ⚙️ Configurações dinâmicas respondem
- [ ] 📱 Interface responsiva em mobile

#### **Solução de Problemas Comuns**

```bash
# Limpar cache do Next.js
rm -rf .next

# Reinstalar dependências
rm -rf node_modules package-lock.json
npm install

# Verificar variáveis de ambiente
npm run env:check

# Verificar conexão Firebase
npm run firebase:test
```

---

## 🏗️ **Estrutura do Projeto**

```
src/
├── app/                    # App Router (Next.js 13+)
│   ├── (auth)/            # Páginas de autenticação
│   ├── admin/             # Páginas administrativas
│   ├── config/            # Configurações do sistema
│   └── reports/           # Relatórios e analytics
├── components/            # Componentes React
│   ├── ui/               # Componentes base (Shadcn)
│   ├── auth/             # Componentes de autenticação
│   ├── layout/           # Layout e navegação
│   └── admin/            # Componentes administrativos
├── hooks/                # Custom hooks
├── lib/                  # Utilitários e configurações
│   ├── firebase.ts       # Configuração Firebase
│   ├── auth.ts           # Lógica de autenticação
│   ├── actions.ts        # Actions do Firestore
│   └── types.ts          # Definições de tipos
└── styles/               # Estilos globais
```

---

## 🔐 **Sistema de Autenticação e Segurança**

### **Hierarquia de Usuários**

#### **🔥 Super Usuários (Nível 3)**

**E-mails Autorizados:**

- `admin@ipda.org.br`
- `marciodesk@ipda.app.br`

**Permissões Completas:**

- ✅ **Gerenciamento Total**: Criar, editar e excluir qualquer usuário
- ✅ **Configuração Global**: Modificar todas as configurações do sistema
- ✅ **Dados Sensíveis**: Acesso a informações confidenciais e métricas avançadas
- ✅ **Audit Trail**: Visualizar logs completos de auditoria
- ✅ **Backup/Restore**: Gerenciar backups e restaurações
- ✅ **Sistema**: Configurar regras de negócio e validações
- ✅ **Deploy**: Controlar atualizações e manutenções

#### **⚙️ Administradores (Nível 2)**

**Permissões Administrativas:**

- ✅ **Usuários Comuns**: Gerenciar usuários não-administrativos
- ✅ **Relatórios**: Gerar e visualizar relatórios administrativos
- ✅ **Configurações Básicas**: Modificar cargos e opções básicas
- ✅ **Moderação**: Revisar e aprovar registros pendentes
- ❌ **Super Funções**: Não pode gerenciar outros admins ou super usuários

#### **👤 Usuários Normais (Nível 1)**

**Permissões Básicas:**

- ✅ **Dashboard Pessoal**: Visualizar métricas próprias
- ✅ **Registro**: Cadastrar presenças e informações pessoais
- ✅ **Relatórios Pessoais**: Ver próprios dados e estatísticas
- ✅ **Perfil**: Editar informações pessoais básicas
- ❌ **Funções Administrativas**: Sem acesso a painéis administrativos

### **🛡️ Implementações de Segurança**

```typescript
// Verificação de autenticação
const isAuthenticated = user && user.uid;

// Verificação de nível de acesso
const isSuperUser = user?.email && SUPER_USERS.includes(user.email);
const isAdmin = user?.role === "admin" || isSuperUser;

// Guards de proteção
<SuperUserGuard>
  <AdminPanel />
</SuperUserGuard>;
```

#### **Regras de Firestore (Produção)**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar super usuários
    function isSuperUser() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@ipda.org.br',
               'marciodesk@ipda.app.br'
             ];
    }

    // Função para verificar admin
    function isAdmin() {
      return isSuperUser() ||
             (request.auth != null &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Attendance: Leitura para todos autenticados, escrita apenas para admins+
    match /attendance/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users: Apenas super usuários podem gerenciar
    match /users/{document} {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
      allow create: if request.auth != null && request.auth.uid == document;
    }

    // System config: Apenas admins+ podem modificar
    match /system/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
```

#### **Validações Client-Side**

```typescript
// Validação de dados com Zod
const attendanceSchema = z.object({
  fullName: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  cpf: z.string().regex(/^\d{11}$/, "CPF deve ter 11 dígitos"),
  status: z.enum(["Presente", "Ausente", "Justificado"]),
  timestamp: z.date(),
});

// Sanitização de inputs
const sanitizeInput = (input: string) => {
  return DOMPurify.sanitize(input.trim());
};
```

#### **Proteções Adicionais**

- 🔒 **Rate Limiting**: Controle de requisições por usuário
- 🛡️ **CORS**: Configurado para domínios específicos
- 🔐 **Headers de Segurança**: X-Frame-Options, CSP, HSTS
- 🚫 **XSS Protection**: Sanitização de inputs e outputs
- 📝 **Audit Logging**: Log completo de ações críticas
- ⚠️ **Anomaly Detection**: Detecção de padrões suspeitos

### **🔍 Monitoramento e Auditoria**

#### **Logs de Auditoria**

```typescript
// Log automático de ações críticas
const auditLog = {
  userId: user.uid,
  userEmail: user.email,
  action: "USER_CREATED",
  targetId: newUser.uid,
  timestamp: new Date(),
  details: { role: "admin", region: "São Paulo" },
  ipAddress: request.ip,
  userAgent: request.headers["user-agent"],
};
```

#### **Alertas de Segurança**

- 🚨 **Login Suspeito**: Tentativas de locais não usuais
- ⚠️ **Múltiplas Tentativas**: Bloqueio temporário após falhas
- 📧 **Notificações**: Email para admins em ações críticas
- 📊 **Dashboard de Segurança**: Métricas de segurança em tempo real

### **🔒 Melhores Práticas Implementadas**

1. **Princípio do Menor Privilégio**: Usuários recebem apenas permissões necessárias
2. **Separação de Responsabilidades**: Diferentes níveis para diferentes funções
3. **Validação Dupla**: Client-side + server-side validation
4. **Criptografia**: Dados sensíveis sempre criptografados
5. **Sessões Seguras**: Timeout automático e renovação de tokens
6. **Backup de Segurança**: Backups criptografados e versionados

---

## 🔧 **Instalação e Configuração**

### **Pré-requisitos**

- **Node.js 18+** - Runtime JavaScript
- **npm** ou **yarn** - Gerenciador de pacotes
- **Conta Firebase** - Backend e autenticação
- **Git** - Controle de versão

### **1. Clone o Repositório**

```bash
git clone https://github.com/AchillesOS/sistema-presenca-ipda.git
cd sistema-presenca-ipda
```

### **2. Instale as Dependências**

```bash
# Usando npm
npm install

# Usando yarn
yarn install
```

### **3. Configuração do Firebase**

#### **3.1. Criar Projeto Firebase**

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Clique em "Criar projeto"
3. Configure o projeto com nome: `sistema-presenca-ipda`
4. Ative Google Analytics (opcional)

#### **3.2. Configurar Serviços**

1. **Authentication**:
   - Ative o provedor "Email/senha"
   - Configure domínios autorizados
2. **Firestore Database**:
   - Crie banco no modo "produção"
   - Configure regras de segurança
3. **Hosting** (opcional):
   - Configure para deploy automático

#### **3.3. Obter Credenciais**

1. Vá em "Configurações do projeto"
2. Na aba "Geral", encontre "Seus aplicativos"
3. Clique em "Web" e registre o app
4. Copie as configurações do Firebase

#### **3.4. Configurar Variáveis de Ambiente**

Crie o arquivo `.env.local` na raiz do projeto:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sistema-presenca-ipda.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sistema-presenca-ipda
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sistema-presenca-ipda.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional: Analytics
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Development
NODE_ENV=development
```

### **4. Configurar Firestore Rules**

#### **4.1. Instalar Firebase CLI**

```bash
npm install -g firebase-tools
firebase login
firebase init firestore
```

#### **4.2. Deploy das Regras**

```bash
firebase deploy --only firestore:rules
```

### **5. Configuração Inicial do Sistema**

#### **5.1. Criar Super Usuário**

1. Execute o projeto em desenvolvimento
2. Registre o primeiro usuário
3. No Firebase Console, adicione o campo `role: 'super'` ao documento do usuário

#### **5.2. Configurar Dados Iniciais**

```bash
# Executar script de configuração inicial (se disponível)
npm run setup:initial-data
```

### **6. Executar o Projeto**

#### **Desenvolvimento**

```bash
npm run dev
# ou
yarn dev
```

Acesse: `http://localhost:9002`

#### **Produção Local**

```bash
npm run build
npm run start
```

#### **Com Turbopack (Mais Rápido)**

```bash
npm run dev:turbo
```

### **7. Configurações Avançadas**

#### **7.1. Analytics e IA (Opcional)**

```bash
# Configurar Genkit para IA
npm run genkit:dev

# Iniciar em modo watch
npm run genkit:watch
```

#### **7.2. Configurar Domínio Personalizado**

1. No Firebase Hosting, adicione domínio customizado
2. Configure DNS para apontar para Firebase
3. SSL será configurado automaticamente

### **8. Verificação da Instalação**

#### **Checklist de Verificação**

- [ ] ✅ Página inicial carrega corretamente
- [ ] 🔐 Sistema de login funciona
- [ ] 📊 Dashboard exibe dados
- [ ] 📝 Formulário de presença funciona
- [ ] 👥 Gerenciamento de usuários acessível (super usuários)
- [ ] ⚙️ Configurações dinâmicas respondem
- [ ] 📱 Interface responsiva em mobile

#### **Solução de Problemas Comuns**

```bash
# Limpar cache do Next.js
rm -rf .next

# Reinstalar dependências
rm -rf node_modules package-lock.json
npm install

# Verificar variáveis de ambiente
npm run env:check

# Verificar conexão Firebase
npm run firebase:test
```

---

## 🏗️ **Estrutura do Projeto**

```
src/
├── app/                    # App Router (Next.js 13+)
│   ├── (auth)/            # Páginas de autenticação
│   ├── admin/             # Páginas administrativas
│   ├── config/            # Configurações do sistema
│   └── reports/           # Relatórios e analytics
├── components/            # Componentes React
│   ├── ui/               # Componentes base (Shadcn)
│   ├── auth/             # Componentes de autenticação
│   ├── layout/           # Layout e navegação
│   └── admin/            # Componentes administrativos
├── hooks/                # Custom hooks
├── lib/                  # Utilitários e configurações
│   ├── firebase.ts       # Configuração Firebase
│   ├── auth.ts           # Lógica de autenticação
│   ├── actions.ts        # Actions do Firestore
│   └── types.ts          # Definições de tipos
└── styles/               # Estilos globais
```

---

## 🔐 **Sistema de Autenticação e Segurança**

### **Hierarquia de Usuários**

#### **🔥 Super Usuários (Nível 3)**

**E-mails Autorizados:**

- `admin@ipda.org.br`
- `marciodesk@ipda.app.br`

**Permissões Completas:**

- ✅ **Gerenciamento Total**: Criar, editar e excluir qualquer usuário
- ✅ **Configuração Global**: Modificar todas as configurações do sistema
- ✅ **Dados Sensíveis**: Acesso a informações confidenciais e métricas avançadas
- ✅ **Audit Trail**: Visualizar logs completos de auditoria
- ✅ **Backup/Restore**: Gerenciar backups e restaurações
- ✅ **Sistema**: Configurar regras de negócio e validações
- ✅ **Deploy**: Controlar atualizações e manutenções

#### **⚙️ Administradores (Nível 2)**

**Permissões Administrativas:**

- ✅ **Usuários Comuns**: Gerenciar usuários não-administrativos
- ✅ **Relatórios**: Gerar e visualizar relatórios administrativos
- ✅ **Configurações Básicas**: Modificar cargos e opções básicas
- ✅ **Moderação**: Revisar e aprovar registros pendentes
- ❌ **Super Funções**: Não pode gerenciar outros admins ou super usuários

#### **👤 Usuários Normais (Nível 1)**

**Permissões Básicas:**

- ✅ **Dashboard Pessoal**: Visualizar métricas próprias
- ✅ **Registro**: Cadastrar presenças e informações pessoais
- ✅ **Relatórios Pessoais**: Ver próprios dados e estatísticas
- ✅ **Perfil**: Editar informações pessoais básicas
- ❌ **Funções Administrativas**: Sem acesso a painéis administrativos

### **🛡️ Implementações de Segurança**

```typescript
// Verificação de autenticação
const isAuthenticated = user && user.uid;

// Verificação de nível de acesso
const isSuperUser = user?.email && SUPER_USERS.includes(user.email);
const isAdmin = user?.role === "admin" || isSuperUser;

// Guards de proteção
<SuperUserGuard>
  <AdminPanel />
</SuperUserGuard>;
```

#### **Regras de Firestore (Produção)**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar super usuários
    function isSuperUser() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@ipda.org.br',
               'marciodesk@ipda.app.br'
             ];
    }

    // Função para verificar admin
    function isAdmin() {
      return isSuperUser() ||
             (request.auth != null &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Attendance: Leitura para todos autenticados, escrita apenas para admins+
    match /attendance/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users: Apenas super usuários podem gerenciar
    match /users/{document} {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
      allow create: if request.auth != null && request.auth.uid == document;
    }

    // System config: Apenas admins+ podem modificar
    match /system/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
```

#### **Validações Client-Side**

```typescript
// Validação de dados com Zod
const attendanceSchema = z.object({
  fullName: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  cpf: z.string().regex(/^\d{11}$/, "CPF deve ter 11 dígitos"),
  status: z.enum(["Presente", "Ausente", "Justificado"]),
  timestamp: z.date(),
});

// Sanitização de inputs
const sanitizeInput = (input: string) => {
  return DOMPurify.sanitize(input.trim());
};
```

#### **Proteções Adicionais**

- 🔒 **Rate Limiting**: Controle de requisições por usuário
- 🛡️ **CORS**: Configurado para domínios específicos
- 🔐 **Headers de Segurança**: X-Frame-Options, CSP, HSTS
- 🚫 **XSS Protection**: Sanitização de inputs e outputs
- 📝 **Audit Logging**: Log completo de ações críticas
- ⚠️ **Anomaly Detection**: Detecção de padrões suspeitos

### **🔍 Monitoramento e Auditoria**

#### **Logs de Auditoria**

```typescript
// Log automático de ações críticas
const auditLog = {
  userId: user.uid,
  userEmail: user.email,
  action: "USER_CREATED",
  targetId: newUser.uid,
  timestamp: new Date(),
  details: { role: "admin", region: "São Paulo" },
  ipAddress: request.ip,
  userAgent: request.headers["user-agent"],
};
```

#### **Alertas de Segurança**

- 🚨 **Login Suspeito**: Tentativas de locais não usuais
- ⚠️ **Múltiplas Tentativas**: Bloqueio temporário após falhas
- 📧 **Notificações**: Email para admins em ações críticas
- 📊 **Dashboard de Segurança**: Métricas de segurança em tempo real

### **🔒 Melhores Práticas Implementadas**

1. **Princípio do Menor Privilégio**: Usuários recebem apenas permissões necessárias
2. **Separação de Responsabilidades**: Diferentes níveis para diferentes funções
3. **Validação Dupla**: Client-side + server-side validation
4. **Criptografia**: Dados sensíveis sempre criptografados
5. **Sessões Seguras**: Timeout automático e renovação de tokens
6. **Backup de Segurança**: Backups criptografados e versionados

---

## 🔧 **Instalação e Configuração**

### **Pré-requisitos**

- **Node.js 18+** - Runtime JavaScript
- **npm** ou **yarn** - Gerenciador de pacotes
- **Conta Firebase** - Backend e autenticação
- **Git** - Controle de versão

### **1. Clone o Repositório**

```bash
git clone https://github.com/AchillesOS/sistema-presenca-ipda.git
cd sistema-presenca-ipda
```

### **2. Instale as Dependências**

```bash
# Usando npm
npm install

# Usando yarn
yarn install
```

### **3. Configuração do Firebase**

#### **3.1. Criar Projeto Firebase**

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Clique em "Criar projeto"
3. Configure o projeto com nome: `sistema-presenca-ipda`
4. Ative Google Analytics (opcional)

#### **3.2. Configurar Serviços**

1. **Authentication**:
   - Ative o provedor "Email/senha"
   - Configure domínios autorizados
2. **Firestore Database**:
   - Crie banco no modo "produção"
   - Configure regras de segurança
3. **Hosting** (opcional):
   - Configure para deploy automático

#### **3.3. Obter Credenciais**

1. Vá em "Configurações do projeto"
2. Na aba "Geral", encontre "Seus aplicativos"
3. Clique em "Web" e registre o app
4. Copie as configurações do Firebase

#### **3.4. Configurar Variáveis de Ambiente**

Crie o arquivo `.env.local` na raiz do projeto:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sistema-presenca-ipda.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sistema-presenca-ipda
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sistema-presenca-ipda.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional: Analytics
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Development
NODE_ENV=development
```

### **4. Configurar Firestore Rules**

#### **4.1. Instalar Firebase CLI**

```bash
npm install -g firebase-tools
firebase login
firebase init firestore
```

#### **4.2. Deploy das Regras**

```bash
firebase deploy --only firestore:rules
```

### **5. Configuração Inicial do Sistema**

#### **5.1. Criar Super Usuário**

1. Execute o projeto em desenvolvimento
2. Registre o primeiro usuário
3. No Firebase Console, adicione o campo `role: 'super'` ao documento do usuário

#### **5.2. Configurar Dados Iniciais**

```bash
# Executar script de configuração inicial (se disponível)
npm run setup:initial-data
```

### **6. Executar o Projeto**

#### **Desenvolvimento**

```bash
npm run dev
# ou
yarn dev
```

Acesse: `http://localhost:9002`

#### **Produção Local**

```bash
npm run build
npm run start
```

#### **Com Turbopack (Mais Rápido)**

```bash
npm run dev:turbo
```

### **7. Configurações Avançadas**

#### **7.1. Analytics e IA (Opcional)**

```bash
# Configurar Genkit para IA
npm run genkit:dev

# Iniciar em modo watch
npm run genkit:watch
```

#### **7.2. Configurar Domínio Personalizado**

1. No Firebase Hosting, adicione domínio customizado
2. Configure DNS para apontar para Firebase
3. SSL será configurado automaticamente

### **8. Verificação da Instalação**

#### **Checklist de Verificação**

- [ ] ✅ Página inicial carrega corretamente
- [ ] 🔐 Sistema de login funciona
- [ ] 📊 Dashboard exibe dados
- [ ] 📝 Formulário de presença funciona
- [ ] 👥 Gerenciamento de usuários acessível (super usuários)
- [ ] ⚙️ Configurações dinâmicas respondem
- [ ] 📱 Interface responsiva em mobile

#### **Solução de Problemas Comuns**

```bash
# Limpar cache do Next.js
rm -rf .next

# Reinstalar dependências
rm -rf node_modules package-lock.json
npm install

# Verificar variáveis de ambiente
npm run env:check

# Verificar conexão Firebase
npm run firebase:test
```

---

## 🏗️ **Estrutura do Projeto**

```
src/
├── app/                    # App Router (Next.js 13+)
│   ├── (auth)/            # Páginas de autenticação
│   ├── admin/             # Páginas administrativas
│   ├── config/            # Configurações do sistema
│   └── reports/           # Relatórios e analytics
├── components/            # Componentes React
│   ├── ui/               # Componentes base (Shadcn)
│   ├── auth/             # Componentes de autenticação
│   ├── layout/           # Layout e navegação
│   └── admin/            # Componentes administrativos
├── hooks/                # Custom hooks
├── lib/                  # Utilitários e configurações
│   ├── firebase.ts       # Configuração Firebase
│   ├── auth.ts           # Lógica de autenticação
│   ├── actions.ts        # Actions do Firestore
│   └── types.ts          # Definições de tipos
└── styles/               # Estilos globais
```

---

## 🔐 **Sistema de Autenticação e Segurança**

### **Hierarquia de Usuários**

#### **🔥 Super Usuários (Nível 3)**

**E-mails Autorizados:**

- `admin@ipda.org.br`
- `marciodesk@ipda.app.br`

**Permissões Completas:**

- ✅ **Gerenciamento Total**: Criar, editar e excluir qualquer usuário
- ✅ **Configuração Global**: Modificar todas as configurações do sistema
- ✅ **Dados Sensíveis**: Acesso a informações confidenciais e métricas avançadas
- ✅ **Audit Trail**: Visualizar logs completos de auditoria
- ✅ **Backup/Restore**: Gerenciar backups e restaurações
- ✅ **Sistema**: Configurar regras de negócio e validações
- ✅ **Deploy**: Controlar atualizações e manutenções

#### **⚙️ Administradores (Nível 2)**

**Permissões Administrativas:**

- ✅ **Usuários Comuns**: Gerenciar usuários não-administrativos
- ✅ **Relatórios**: Gerar e visualizar relatórios administrativos
- ✅ **Configurações Básicas**: Modificar cargos e opções básicas
- ✅ **Moderação**: Revisar e aprovar registros pendentes
- ❌ **Super Funções**: Não pode gerenciar outros admins ou super usuários

#### **👤 Usuários Normais (Nível 1)**

**Permissões Básicas:**

- ✅ **Dashboard Pessoal**: Visualizar métricas próprias
- ✅ **Registro**: Cadastrar presenças e informações pessoais
- ✅ **Relatórios Pessoais**: Ver próprios dados e estatísticas
- ✅ **Perfil**: Editar informações pessoais básicas
- ❌ **Funções Administrativas**: Sem acesso a painéis administrativos

### **🛡️ Implementações de Segurança**

```typescript
// Verificação de autenticação
const isAuthenticated = user && user.uid;

// Verificação de nível de acesso
const isSuperUser = user?.email && SUPER_USERS.includes(user.email);
const isAdmin = user?.role === "admin" || isSuperUser;

// Guards de proteção
<SuperUserGuard>
  <AdminPanel />
</SuperUserGuard>;
```

#### **Regras de Firestore (Produção)**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar super usuários
    function isSuperUser() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@ipda.org.br',
               'marciodesk@ipda.app.br'
             ];
    }

    // Função para verificar admin
    function isAdmin() {
      return isSuperUser() ||
             (request.auth != null &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Attendance: Leitura para todos autenticados, escrita apenas para admins+
    match /attendance/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users: Apenas super usuários podem gerenciar
    match /users/{document} {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
      allow create: if request.auth != null && request.auth.uid == document;
    }

    // System config: Apenas admins+ podem modificar
    match /system/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
```

#### **Validações Client-Side**

```typescript
// Validação de dados com Zod
const attendanceSchema = z.object({
  fullName: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  cpf: z.string().regex(/^\d{11}$/, "CPF deve ter 11 dígitos"),
  status: z.enum(["Presente", "Ausente", "Justificado"]),
  timestamp: z.date(),
});

// Sanitização de inputs
const sanitizeInput = (input: string) => {
  return DOMPurify.sanitize(input.trim());
};
```

#### **Proteções Adicionais**

- 🔒 **Rate Limiting**: Controle de requisições por usuário
- 🛡️ **CORS**: Configurado para domínios específicos
- 🔐 **Headers de Segurança**: X-Frame-Options, CSP, HSTS
- 🚫 **XSS Protection**: Sanitização de inputs e outputs
- 📝 **Audit Logging**: Log completo de ações críticas
- ⚠️ **Anomaly Detection**: Detecção de padrões suspeitos

### **🔍 Monitoramento e Auditoria**

#### **Logs de Auditoria**

```typescript
// Log automático de ações críticas
const auditLog = {
  userId: user.uid,
  userEmail: user.email,
  action: "USER_CREATED",
  targetId: newUser.uid,
  timestamp: new Date(),
  details: { role: "admin", region: "São Paulo" },
  ipAddress: request.ip,
  userAgent: request.headers["user-agent"],
};
```

#### **Alertas de Segurança**

- 🚨 **Login Suspeito**: Tentativas de locais não usuais
- ⚠️ **Múltiplas Tentativas**: Bloqueio temporário após falhas
- 📧 **Notificações**: Email para admins em ações críticas
- 📊 **Dashboard de Segurança**: Métricas de segurança em tempo real

### **🔒 Melhores Práticas Implementadas**

1. **Princípio do Menor Privilégio**: Usuários recebem apenas permissões necessárias
2. **Separação de Responsabilidades**: Diferentes níveis para diferentes funções
3. **Validação Dupla**: Client-side + server-side validation
4. **Criptografia**: Dados sensíveis sempre criptografados
5. **Sessões Seguras**: Timeout automático e renovação de tokens
6. **Backup de Segurança**: Backups criptografados e versionados

---

## 🔧 **Instalação e Configuração**

### **Pré-requisitos**

- **Node.js 18+** - Runtime JavaScript
- **npm** ou **yarn** - Gerenciador de pacotes
- **Conta Firebase** - Backend e autenticação
- **Git** - Controle de versão

### **1. Clone o Repositório**

```bash
git clone https://github.com/AchillesOS/sistema-presenca-ipda.git
cd sistema-presenca-ipda
```

### **2. Instale as Dependências**

```bash
# Usando npm
npm install

# Usando yarn
yarn install
```

### **3. Configuração do Firebase**

#### **3.1. Criar Projeto Firebase**

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Clique em "Criar projeto"
3. Configure o projeto com nome: `sistema-presenca-ipda`
4. Ative Google Analytics (opcional)

#### **3.2. Configurar Serviços**

1. **Authentication**:
   - Ative o provedor "Email/senha"
   - Configure domínios autorizados
2. **Firestore Database**:
   - Crie banco no modo "produção"
   - Configure regras de segurança
3. **Hosting** (opcional):
   - Configure para deploy automático

#### **3.3. Obter Credenciais**

1. Vá em "Configurações do projeto"
2. Na aba "Geral", encontre "Seus aplicativos"
3. Clique em "Web" e registre o app
4. Copie as configurações do Firebase

#### **3.4. Configurar Variáveis de Ambiente**

Crie o arquivo `.env.local` na raiz do projeto:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sistema-presenca-ipda.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sistema-presenca-ipda
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sistema-presenca-ipda.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional: Analytics
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Development
NODE_ENV=development
```

### **4. Configurar Firestore Rules**

#### **4.1. Instalar Firebase CLI**

```bash
npm install -g firebase-tools
firebase login
firebase init firestore
```

#### **4.2. Deploy das Regras**

```bash
firebase deploy --only firestore:rules
```

### **5. Configuração Inicial do Sistema**

#### **5.1. Criar Super Usuário**

1. Execute o projeto em desenvolvimento
2. Registre o primeiro usuário
3. No Firebase Console, adicione o campo `role: 'super'` ao documento do usuário

#### **5.2. Configurar Dados Iniciais**

```bash
# Executar script de configuração inicial (se disponível)
npm run setup:initial-data
```

### **6. Executar o Projeto**

#### **Desenvolvimento**

```bash
npm run dev
# ou
yarn dev
```

Acesse: `http://localhost:9002`

#### **Produção Local**

```bash
npm run build
npm run start
```

#### **Com Turbopack (Mais Rápido)**

```bash
npm run dev:turbo
```

### **7. Configurações Avançadas**

#### **7.1. Analytics e IA (Opcional)**

```bash
# Configurar Genkit para IA
npm run genkit:dev

# Iniciar em modo watch
npm run genkit:watch
```

#### **7.2. Configurar Domínio Personalizado**

1. No Firebase Hosting, adicione domínio customizado
2. Configure DNS para apontar para Firebase
3. SSL será configurado automaticamente

### **8. Verificação da Instalação**

#### **Checklist de Verificação**

- [ ] ✅ Página inicial carrega corretamente
- [ ] 🔐 Sistema de login funciona
- [ ] 📊 Dashboard exibe dados
- [ ] 📝 Formulário de presença funciona
- [ ] 👥 Gerenciamento de usuários acessível (super usuários)
- [ ] ⚙️ Configurações dinâmicas respondem
- [ ] 📱 Interface responsiva em mobile

#### **Solução de Problemas Comuns**

```bash
# Limpar cache do Next.js
rm -rf .next

# Reinstalar dependências
rm -rf node_modules package-lock.json
npm install

# Verificar variáveis de ambiente
npm run env:check

# Verificar conexão Firebase
npm run firebase:test
```

---

## 🏗️ **Estrutura do Projeto**

```
src/
├── app/                    # App Router (Next.js 13+)
│   ├── (auth)/            # Páginas de autenticação
│   ├── admin/             # Páginas administrativas
│   ├── config/            # Configurações do sistema
│   └── reports/           # Relatórios e analytics
├── components/            # Componentes React
│   ├── ui/               # Componentes base (Shadcn)
│   ├── auth/             # Componentes de autenticação
│   ├── layout/           # Layout e navegação
│   └── admin/            # Componentes administrativos
├── hooks/                # Custom hooks
├── lib/                  # Utilitários e configurações
│   ├── firebase.ts       # Configuração Firebase
│   ├── auth.ts           # Lógica de autenticação
│   ├── actions.ts        # Actions do Firestore
│   └── types.ts          # Definições de tipos
└── styles/               # Estilos globais
```

---

## 🔐 **Sistema de Autenticação e Segurança**

### **Hierarquia de Usuários**

#### **🔥 Super Usuários (Nível 3)**

**E-mails Autorizados:**

- `admin@ipda.org.br`
- `marciodesk@ipda.app.br`

**Permissões Completas:**

- ✅ **Gerenciamento Total**: Criar, editar e excluir qualquer usuário
- ✅ **Configuração Global**: Modificar todas as configurações do sistema
- ✅ **Dados Sensíveis**: Acesso a informações confidenciais e métricas avançadas
- ✅ **Audit Trail**: Visualizar logs completos de auditoria
- ✅ **Backup/Restore**: Gerenciar backups e restaurações
- ✅ **Sistema**: Configurar regras de negócio e validações
- ✅ **Deploy**: Controlar atualizações e manutenções

#### **⚙️ Administradores (Nível 2)**

**Permissões Administrativas:**

- ✅ **Usuários Comuns**: Gerenciar usuários não-administrativos
- ✅ **Relatórios**: Gerar e visualizar relatórios administrativos
- ✅ **Configurações Básicas**: Modificar cargos e opções básicas
- ✅ **Moderação**: Revisar e aprovar registros pendentes
- ❌ **Super Funções**: Não pode gerenciar outros admins ou super usuários

#### **👤 Usuários Normais (Nível 1)**

**Permissões Básicas:**

- ✅ **Dashboard Pessoal**: Visualizar métricas próprias
- ✅ **Registro**: Cadastrar presenças e informações pessoais
- ✅ **Relatórios Pessoais**: Ver próprios dados e estatísticas
- ✅ **Perfil**: Editar informações pessoais básicas
- ❌ **Funções Administrativas**: Sem acesso a painéis administrativos

### **🛡️ Implementações de Segurança**

```typescript
// Verificação de autenticação
const isAuthenticated = user && user.uid;

// Verificação de nível de acesso
const isSuperUser = user?.email && SUPER_USERS.includes(user.email);
const isAdmin = user?.role === "admin" || isSuperUser;

// Guards de proteção
<SuperUserGuard>
  <AdminPanel />
</SuperUserGuard>;
```

#### **Regras de Firestore (Produção)**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar super usuários
    function isSuperUser() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@ipda.org.br',
               'marciodesk@ipda.app.br'
             ];
    }

    // Função para verificar admin
    function isAdmin() {
      return isSuperUser() ||
             (request.auth != null &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Attendance: Leitura para todos autenticados, escrita apenas para admins+
    match /attendance/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users: Apenas super usuários podem gerenciar
    match /users/{document} {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
      allow create: if request.auth != null && request.auth.uid == document;
    }

    // System config: Apenas admins+ podem modificar
    match /system/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
```

#### **Validações Client-Side**

```typescript
// Validação de dados com Zod
const attendanceSchema = z.object({
  fullName: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  cpf: z.string().regex(/^\d{11}$/, "CPF deve ter 11 dígitos"),
  status: z.enum(["Presente", "Ausente", "Justificado"]),
  timestamp: z.date(),
});

// Sanitização de inputs
const sanitizeInput = (input: string) => {
  return DOMPurify.sanitize(input.trim());
};
```

#### **Proteções Adicionais**

- 🔒 **Rate Limiting**: Controle de requisições por usuário
- 🛡️ **CORS**: Configurado para domínios específicos
- 🔐 **Headers de Segurança**: X-Frame-Options, CSP, HSTS
- 🚫 **XSS Protection**: Sanitização de inputs e outputs
- 📝 **Audit Logging**: Log completo de ações críticas
- ⚠️ **Anomaly Detection**: Detecção de padrões suspeitos

### **🔍 Monitoramento e Auditoria**

#### **Logs de Auditoria**

```typescript
// Log automático de ações críticas
const auditLog = {
  userId: user.uid,
  userEmail: user.email,
  action: "USER_CREATED",
  targetId: newUser.uid,
  timestamp: new Date(),
  details: { role: "admin", region: "São Paulo" },
  ipAddress: request.ip,
  userAgent: request.headers["user-agent"],
};
```

#### **Alertas de Segurança**

- 🚨 **Login Suspeito**: Tentativas de locais não usuais
- ⚠️ **Múltiplas Tentativas**: Bloqueio temporário após falhas
- 📧 **Notificações**: Email para admins em ações críticas
- 📊 **Dashboard de Segurança**: Métricas de segurança em tempo real

### **🔒 Melhores Práticas Implementadas**

1. **Princípio do Menor Privilégio**: Usuários recebem apenas permissões necessárias
2. **Separação de Responsabilidades**: Diferentes níveis para diferentes funções
3. **Validação Dupla**: Client-side + server-side validation
4. **Criptografia**: Dados sensíveis sempre criptografados
5. **Sessões Seguras**: Timeout automático e renovação de tokens
6. **Backup de Segurança**: Backups criptografados e versionados

---

## 🔧 **Instalação e Configuração**

### **Pré-requisitos**

- **Node.js 18+** - Runtime JavaScript
- **npm** ou **yarn** - Gerenciador de pacotes
- **Conta Firebase** - Backend e autenticação
- **Git** - Controle de versão

### **1. Clone o Repositório**

```bash
git clone https://github.com/AchillesOS/sistema-presenca-ipda.git
cd sistema-presenca-ipda
```

### **2. Instale as Dependências**

```bash
# Usando npm
npm install

# Usando yarn
yarn install
```

### **3. Configuração do Firebase**

#### **3.1. Criar Projeto Firebase**

1. Acesse o [Firebase Console](https://console.firebase.google.com/)
2. Clique em "Criar projeto"
3. Configure o projeto com nome: `sistema-presenca-ipda`
4. Ative Google Analytics (opcional)

#### **3.2. Configurar Serviços**

1. **Authentication**:
   - Ative o provedor "Email/senha"
   - Configure domínios autorizados
2. **Firestore Database**:
   - Crie banco no modo "produção"
   - Configure regras de segurança
3. **Hosting** (opcional):
   - Configure para deploy automático

#### **3.3. Obter Credenciais**

1. Vá em "Configurações do projeto"
2. Na aba "Geral", encontre "Seus aplicativos"
3. Clique em "Web" e registre o app
4. Copie as configurações do Firebase

#### **3.4. Configurar Variáveis de Ambiente**

Crie o arquivo `.env.local` na raiz do projeto:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyC...
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=sistema-presenca-ipda.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=sistema-presenca-ipda
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=sistema-presenca-ipda.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional: Analytics
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Development
NODE_ENV=development
```

### **4. Configurar Firestore Rules**

#### **4.1. Instalar Firebase CLI**

```bash
npm install -g firebase-tools
firebase login
firebase init firestore
```

#### **4.2. Deploy das Regras**

```bash
firebase deploy --only firestore:rules
```

### **5. Configuração Inicial do Sistema**

#### **5.1. Criar Super Usuário**

1. Execute o projeto em desenvolvimento
2. Registre o primeiro usuário
3. No Firebase Console, adicione o campo `role: 'super'` ao documento do usuário

#### **5.2. Configurar Dados Iniciais**

```bash
# Executar script de configuração inicial (se disponível)
npm run setup:initial-data
```

### **6. Executar o Projeto**

#### **Desenvolvimento**

```bash
npm run dev
# ou
yarn dev
```

Acesse: `http://localhost:9002`

#### **Produção Local**

```bash
npm run build
npm run start
```

#### **Com Turbopack (Mais Rápido)**

```bash
npm run dev:turbo
```

### **7. Configurações Avançadas**

#### **7.1. Analytics e IA (Opcional)**

```bash
# Configurar Genkit para IA
npm run genkit:dev

# Iniciar em modo watch
npm run genkit:watch
```

#### **7.2. Configurar Domínio Personalizado**

1. No Firebase Hosting, adicione domínio customizado
2. Configure DNS para apontar para Firebase
3. SSL será configurado automaticamente

### **8. Verificação da Instalação**

#### **Checklist de Verificação**

- [ ] ✅ Página inicial carrega corretamente
- [ ] 🔐 Sistema de login funciona
- [ ] 📊 Dashboard exibe dados
- [ ] 📝 Formulário de presença funciona
- [ ] 👥 Gerenciamento de usuários acessível (super usuários)
- [ ] ⚙️ Configurações dinâmicas respondem
- [ ] 📱 Interface responsiva em mobile

#### **Solução de Problemas Comuns**

```bash
# Limpar cache do Next.js
rm -rf .next

# Reinstalar dependências
rm -rf node_modules package-lock.json
npm install

# Verificar variáveis de ambiente
npm run env:check

# Verificar conexão Firebase
npm run firebase:test
```

---

## 🏗️ **Estrutura do Projeto**

```
src/
├── app/                    # App Router (Next.js 13+)
│   ├── (auth)/            # Páginas de autenticação
│   ├── admin/             # Páginas administrativas
│   ├── config/            # Configurações do sistema
│   └── reports/           # Relatórios e analytics
├── components/            # Componentes React
│   ├── ui/               # Componentes base (Shadcn)
│   ├── auth/             # Componentes de autenticação
│   ├── layout/           # Layout e navegação
│   └── admin/            # Componentes administrativos
├── hooks/                # Custom hooks
├── lib/                  # Utilitários e configurações
│   ├── firebase.ts       # Configuração Firebase
│   ├── auth.ts           # Lógica de autenticação
│   ├── actions.ts        # Actions do Firestore
│   └── types.ts          # Definições de tipos
└── styles/               # Estilos globais
```

---

## 🔐 **Sistema de Autenticação e Segurança**

### **Hierarquia de Usuários**

#### **🔥 Super Usuários (Nível 3)**

**E-mails Autorizados:**

- `admin@ipda.org.br`
- `marciodesk@ipda.app.br`

**Permissões Completas:**

- ✅ **Gerenciamento Total**: Criar, editar e excluir qualquer usuário
- ✅ **Configuração Global**: Modificar todas as configurações do sistema
- ✅ **Dados Sensíveis**: Acesso a informações confidenciais e métricas avançadas
- ✅ **Audit Trail**: Visualizar logs completos de auditoria
- ✅ **Backup/Restore**: Gerenciar backups e restaurações
- ✅ **Sistema**: Configurar regras de negócio e validações
- ✅ **Deploy**: Controlar atualizações e manutenções

#### **⚙️ Administradores (Nível 2)**

**Permissões Administrativas:**

- ✅ **Usuários Comuns**: Gerenciar usuários não-administrativos
- ✅ **Relatórios**: Gerar e visualizar relatórios administrativos
- ✅ **Configurações Básicas**: Modificar cargos e opções básicas
- ✅ **Moderação**: Revisar e aprovar registros pendentes
- ❌ **Super Funções**: Não pode gerenciar outros admins ou super usuários

#### **👤 Usuários Normais (Nível 1)**

**Permissões Básicas:**

- ✅ **Dashboard Pessoal**: Visualizar métricas próprias
- ✅ **Registro**: Cadastrar presenças e informações pessoais
- ✅ **Relatórios Pessoais**: Ver próprios dados e estatísticas
- ✅ **Perfil**: Editar informações pessoais básicas
- ❌ **Funções Administrativas**: Sem acesso a painéis administrativos

### **🛡️ Implementações de Segurança**

```typescript
// Verificação de autenticação
const isAuthenticated = user && user.uid;

// Verificação de nível de acesso
const isSuperUser = user?.email && SUPER_USERS.includes(user.email);
const isAdmin = user?.role === "admin" || isSuperUser;

// Guards de proteção
<SuperUserGuard>
  <AdminPanel />
</SuperUserGuard>;
```

#### **Regras de Firestore (Produção)**

```javascript
rules_version;
```
